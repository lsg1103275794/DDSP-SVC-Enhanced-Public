# DDSP-SVC 6.3 开发日志 (CHANGELOG)

## [2026-01-13] - 现代化UI升级与MSST音频分离工具集成

### 已完成 (Added/Changed)
- **全局UI现代化改造**:
    - 对整个项目进行了苹果风格UI美化，采用现代化的玻璃拟态设计。
    - 更新配色方案：主色调靛蓝色(#6366f1) + 金色点缀(#f59e0b)，符合中国人审美。
    - 添加毛玻璃效果(backdrop-filter)、渐变背景、立体阴影和微动画。
    - 更新了全局样式文件 `web/src/style.css`，建立了统一的CSS变量系统。
- **预处理页面布局优化与主题突出**:
    - 重构预处理页面为专业的音频数据集预处理主题。
    - 添加音乐主题的头部区域，集成MusicalNotesOutline图标和统计数据展示。
    - 简化左侧指引为四步流程，采用编号圆圈和卡片式布局。
    - 将MSST分离功能移至音频工具箱，在预处理页面添加跳转提示。
    - 更新指引说明，将"人声分离"改为"音频处理工具箱"，保持功能分类清晰。
- **音频工具箱MSST分离功能完整集成 (ToolsView.vue)**:
    - 新增第四个标签页"MSST 音频分离"，提供专业的AI音频分离服务。
    - 集成5个预训练MSST模型：
        * BS-Roformer-Resurrection (195MB) - 人声分离专用 ⭐推荐
        * KimMelBandRoformer (870MB) - 卡拉OK分离
        * mel_band_roformer_karaoke_becruily (1.6GB) - 高质量卡拉OK分离
        * denoise_mel_band_roformer (870MB) - 降噪处理
        * dereverb_echo_mbr_fused (434MB) - 去混响处理
    - 实现完整的配置界面：模型选择、输入文件、输出目录、轨道数(2/4轨)、处理质量(快速/标准/高质量)。
    - 集成任务监控系统，支持实时进度追踪和状态显示。
    - 添加结果展示区域：分离后的音频文件支持播放预览和下载。
    - 使用渐变按钮、悬浮效果和现代化卡片设计，与整体风格保持一致。

### 技术实现亮点
- **响应式数据管理**：完整的Vue 3响应式状态管理，包括配置对象和结果数组。
- **API集成**：与后端`/api/v1/preprocess/tool/msst-separate`端点完整集成。
- **用户体验优化**：直观的模型推荐、质量标签、文件路径显示等细节功能。
- **视觉效果增强**：立体阴影、渐变背景、毛玻璃效果和流畅的动画过渡。

### 功能分类优化
- **预处理页面**：专注于训练数据集的准备和特征提取。
- **音频工具箱**：整合基础音频处理和高级AI分离功能。
- **模型训练**：专门的模型训练和监控界面。
- **音频推理**：实时音频转换和处理功能。

现在DDSP-SVC 6.3拥有了完整的现代化界面和专业的音频处理工具链，从基础工具到高级AI分离，为用户提供了从数据准备到最终推理的全流程解决方案。

---

## [2026-01-13] - UI 视觉体验重大升级与预处理重构

### 已完成 (Added/Changed)
- **视觉语言重塑**: 采用深色深邃主题，增强了玻璃拟态 (Glassmorphism) 效果。
- **侧边栏升级**: 优化了菜单激活状态的视觉反馈，增加了发光背景与更清晰的图标。
- **预处理页面 (PreprocessView) 重构**:
    - **三栏式布局**: 左侧指引说明、中间处理配置、右侧文件与任务管理，逻辑更加清晰。
    - **数据导入区**: 强化了拖拽上传的视觉引导。
    - **精细化配置**: 增加了模型版本选择，优化了步进器与下拉框的交互体验。
    - **文件管理器**: 集成了上传与已处理文件的分栏管理，支持实时查看文件状态。
- **主题一致性**: 全局字体与间距优化，提升了在高分屏下的阅读舒适度。
- **模块精简与工具箱重构**:
    
    - **重构工具箱 (ToolsView)**: 将“切音机”、“重采样”与“格式转换”等核心基础工具提升至顶级标签页，简化了层级结构。
    - **文档规范化**:
        - 创建了 `web/web_docs` 目录。
        - 将 `MODERN_UI_PREVIEW.md` 与 `UI_Modernization_Report.md` 移入 `web_docs` 进行统一管理。
    - **文档同步**: 更新了现代化升级报告，移除过时的进阶工具设计参考。
- **上传逻辑重构与优化**:
  - **单文件上传模式**: 
      - 强制校验音频属性：必须为 WAV、单声道、44.1kHz。
      - 自动化存储：自动在 `dataset_raw/角色名/` 下创建 `01` 目录并存入。
  - **文件夹上传模式**: 
      - 智能提取：直接复用上传文件夹的根目录名作为角色名。
      - 结构保留：完整保留并重构文件夹内部的子目录结构，跳过严格合规性校验（方便批量导入）。
  - **FFmpeg 环境集成**: 自动识别并配置本地 `ffmpeg` 路径，确保 `torchaudio` 能够正常处理非 WAV 格式文件的验证，极大提升了上传接口的稳定性。
  - **FFmpeg 环境审计**: 全面审计 FFmpeg 环境配置，确认 `api/main.py` 为唯一环境变量注入点，确保多模块调用一致性。
  - **fix(web)**: 配置 Vite 开发服务器代理 (`/api` -> `http://127.0.0.1:8000`)，解决前端 API 请求 404 返回 HTML 导致的 JSON 解析错误。
  - **fix(api)**: 修复 `api/routes/preprocess.py` 中的缩进错误导致的 `SyntaxError`。
   - **fix(api)**: 移除上传逻辑中的临时目录回退机制。现在，若未提供角色名，文件将自动存入 `dataset_raw/未命名角色`，彻底解决文件"不知去向"（误入临时目录）的问题。
   - **debug(api)**: 在 `save_to_raw` 中添加详细的调试日志和写入后校验，强制使用绝对路径确保文件正确落地。
    - **feat(api)**: 优化 `list_raw_datasets` 扫描逻辑，增加调试日志，并支持对 `dataset_raw` 下所有子目录的健壮性扫描，防止因单个目录权限问题导致整体扫描失败。
    - **feat(web)**: 在数据集选择器旁添加「刷新」按钮，允许用户手动同步后端数据集状态，方便手动文件变更后的即时更新。
    - **存储逻辑纠偏**: 修复了文件夹上传时由于缺少角色名 Header 导致文件误入 `storage/uploads` 临时目录的 Bug，确保所有结构化上传均能准确进入 `dataset_raw`。
  - **交互逻辑改进**:
      - 移除前端硬性拦截，将角色名与目录结构校验交由后端统一处理，彻底解决不同浏览器下 `webkitRelativePath` 属性差异导致的上传阻塞问题。
      - 增强了后端错误提示，明确区分“单文件缺失角色名”与“音频合规性”错误。
      - 优化了数据集扫描逻辑，支持 `m4a`、`ogg` 等更多音频格式的识别与展示。
- **音频质量守门员 (Audio Validation)**:
    - **严格合规性检查**: 后端上传接口增加了音频格式校验（必须为 WAV、单声道、44.1kHz）。
    - **智能错误引导**: 当上传不合规音频时，前端会弹出错误提示，并提供一键跳转至“工具箱”的快捷按钮，引导用户进行格式转换或重采样。
    - **UI 提示更新**: 明确了预处理阶段对原始音频的格式要求。
- **修复**:
    - 修复了预处理页面 `v-else` 语法错误导致的编译失败。
    - 优化了任务轮询逻辑，确保数据集列表在任务完成后自动刷新。

### 下一步计划 (Next Steps)
- **模型训练可视化**: 增加 Loss 曲线图表显示。
- **状态持久化**: 引入 Pinia 管理全局任务状态，确保刷新不丢失进度。
- **多语言支持**: 预留 i18n 接口以支持中英文切换。

---
*记录人: SVC Veteran Artisan & Architect*

## [2026-01-13] - 现代化架构搭建与核心集成阶段

### 已完成 (Added/Changed)
- **后端架构与逻辑增强**:
    - 搭建了模块化的 FastAPI 目录结构 (`api/core`, `api/models`, `api/routes`, `api/services`)。
    - 实现了核心配置模块 `api/core/config.py`，支持自动化路径管理与设备检测。
    - **集成 MSST 引擎**: 封装 `MSSTService`，支持 BS-Roformer 模型进行高质量人声分离。
    - **完善服务层集成**:
        - `InferenceService`: 支持自动从 MSST 分离结果 (`processed/separated`) 或切片结果中加载音频，并缓存提取器。
        - `TrainService`: 适配 `train_reflow.py` 子进程管理，支持实时日志回传 (`/logs` 接口)。
        - `PreprocessService`: 整合 MSST 分离与 `slicer.py` 切片逻辑，支持多类型文件列表查询。
    - 强化了音频上传逻辑：增加 `storage/uploads` 目录自动创建、文件类型安全性校验、短 ID 唯一命名。
    - 修复了 `torchaudio`, `os`, `typing.List` 等模块导入缺失及路径解析错误。
- **前端 Vue 3 工程化落地**:
    - 完整搭建了 Vue 3 + Vite + TypeScript 基础架构。
    - 实现了苹果风格 (Apple Style) 的三大业务页面，并完成了与后端 V1 API 的深度联调。
    - 修复了 `@vicons/ionicons5` 依赖缺失及 `InferenceView.vue` 中的音频路径解析逻辑。
    - 实现了预处理任务的异步轮询与训练 Step 的实时解析显示。
- **UI/UX 与文档**:
    - 确定并应用了 Apple 风格视觉规范。
    - 深度更新了 [API_Documentation.md](../docs/API_Documentation.md)，明确了 MSST 与核心引擎的集成链路。

### 下一步计划 (Next Steps)
- **前端状态持久化**: 使用 Pinia 持久化任务列表，防止页面刷新丢失进度。
- **多说话人支持**: 在推理界面增加说话人列表动态加载。
- **Reflow 推理优化**: 集成 `main_reflow.py` 中的 ODE Solver 参数调节。

---
*记录人: SVC Architect & Product Manager*
